name: CI/CD Pipeline

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Set up Docker Compose
        run: docker-compose -f ./docker-compose.yml up -d

      - name: Wait for PostgreSQL to be ready
        run: |
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for PostgreSQL to be ready..."
            sleep 2
          done
          echo "PostgreSQL is ready!"

      - name: Execute PostgreSQL script
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: psql -h localhost -p 5432 -U postgres -f ./script_dreamvacations.sql

      - name: Download Trivy
        run: |
          sudo apt-get install wget gnupg
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb generic main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy


      - name: Scan Docker image with Trivy
        run: |
          trivy image --format json --output trivy_postgres_report.json postgres:latest
          trivy image --format json --output trivy_frontend_image_report.json dream-vacation-app-frontend:latest
          trivy image --format json --output trivy_backend_image_report.json dream-vacation-app-backend:latest
          trivy image --format json --output trivy_adminer_image_report.json adminer:latest

      - name: Commit Trivy scan results
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add trivy_*.json
          git commit -m "Add Trivy scan results"
          git push
